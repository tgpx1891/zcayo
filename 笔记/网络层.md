## 4.1  网络层提供的两种服务

### 虚电路服务

让网络负责可靠交付。通信之前先建立虚电路 (Virtual Circuit)，以保证双方通信所需的一切网络资源。 如果再使用可靠传输的网络协议，就可使所发送的分组无差错按序到达终点，不丢失、不重复。虚电路表示这只是一条逻辑上的连接，分组都沿着这条逻辑连接按照存储转发方式传送，而并不是真正建立了一条物理连接。而电路交换的电话通信是先建立了一条真正的连接。因此分组交换的虚连接和电路交换的连接只是类似，但并不完全一样

### 数据报服务

网络提供数据报服务。网络层向上只提供简单灵活的、无连接的、尽最大努力交付的数据报服务。网络在发送分组时不需要先建立连接。每一个分组（即 IP 数据报）独立发送，与其前后的分组无关（不进行编号）。网络层不提供服务质量的承诺。即所传送的分组可能出错、丢失、重复和失序（不按序到达终点），当然也不保证分组传送的时限。如果主机（即端系统）中的进程之间的通信需要是可靠的，那么就由网络的主机中的运输层负责可靠交付（包括差错处理、流量控制等） 。采用这种设计思路的好处是：网络的造价大大降低，运行方式灵活，能够适应多种应用

### 虚电路服务与数据报服务的对比

| 对比的方面                     | **虚电路服务**                                     | **数据报服务**                                         |
| ------------------------------ | -------------------------------------------------- | ------------------------------------------------------ |
| **思路**                       | **可靠通信应当由网络来保证**                       | **可靠通信应当由用户主机来保证**                       |
| **连接的建立**                 | **必须有**                                         | **不需要**                                             |
| **终点地址**                   | **仅在连接建立阶段使用，每个分组使用短的虚电路号** | **每个分组都有终点的完整地址**                         |
| **分组的转发**                 | 属于同一条虚电路的分组均按照同一路由进行转发       | **每个分组独立选择路由进行转发**                       |
| **当结点出故障时**             | **所有通过出故障的结点的虚电路均不能工作**         | **出故障的结点可能会丢失分组，一些路由可能会发生变化** |
| **分组的顺序**                 | **总是按发送顺序到达终点**                         | **到达终点时不一定按发送顺序**                         |
| **端到端的差错处理和流量控制** | **可以由网络负责，也可以由用户主机负责**           | 由用户主机负责                                         |

## 4.2  网际协议 IP

网际协议 IP 是 TCP/IP 体系中两个最主要的协议之一。与 IP 协议配套使用的还有三个协议：地址解析协议 ARP(Address Resolution Protocol)，网际控制报文协议 ICMP(Internet Control Message Protocol)，网际组管理协议 IGMP(Internet Group Management Protocol)

### 虚拟互连网络

将网络互相连接起来要使用一些中间设备，中间设备又称为中间系统或中继 (relay)系统。有以下五种不同的中间设备：
物理层中继系统：转发器 (repeater)，数据链路层中继系统：网桥 或 桥接器 (bridge)，网络层中继系统：路由器 (router)，网桥和路由器的混合物：桥路器 (brouter)，网络层以上的中继系统：网关 (gateway)。网络互连都是指用路由器进行网络互连和路由选择

### 分类的 IP 地址

我们把整个因特网看成为一个单一的、抽象的网络。IP 地址就是给每个连接在互联网上的主机（或路由器）分配一个在全世界范围是唯一的 32 位的标识符。IP 地址现在由互联网名字和数字分配机构 ICANN (Internet Corporation for Assigned Names and Numbers)进行分配。将IP地址划分为若干个固定类，每一类地址都由两个固定长度的字段组成，其中一个字段是网络号 net-id，它标志主机（或路由器）所连接到的网络，而另一个字段则是主机号 host-id，它标志该主机（或路由器）。主机号在它前面的网络号所指明的网络范围内必须是唯一的，由此可见，一个 IP 地址在整个互联网范围内是唯一的。这种两级的 IP 地址可以记为：IP 地址 ::= { <网络号>, <主机号>} （::=  代表“定义为”）

![捕获2](E:\我的电脑\图片\学习\计算机网络\捕获2.PNG)

#### 点分十进制记法 

机器中存放的 IP 地址是 32 位二进制代码，每 8 位为一组，将每 8 位的二进制数转换为十进制数

IP 地址的指派范围

| 网络**类别** | **最大可****指派****的网络****数** | **第一个可指派****的****网络****号** | **最后一个可****指派的****网络****号** | **每个网络****中****最大****主机数** |
| ------------ | ---------------------------------- | ------------------------------------ | -------------------------------------- | ------------------------------------ |
| **A**        | **126 (2****7** **– 2)**           | 1                                    | **126**                                | **16777214**                         |
| **B**        | **16383 (2****14** **– 1)**        | **128.1**                            | **191.255**                            | **65534**                            |
| **C**        | **2097151 (2****21** **– 1)**      | 192.0.1                              | **223.255.255**                        | 254                                  |

一般不使用的特殊的 IP 地址

| 网络号      | **主机号**                             | **源地址****使用** | **目的地址****使用** | **代表的意思**                                            |
| ----------- | -------------------------------------- | ------------------ | -------------------- | --------------------------------------------------------- |
| **0**       | **0**                                  | **可以**           | **不可**             | **在本网络上的本主机（见****6.6****节****DHCP****协议）** |
| **0**       | **host-id**                            | **可以**           | **不可**             | **在本网络上的某台主机****host-id**                       |
| **全****1** | **全****1**                            | 不可               | **可以**             | **只在本网络上进行广播（各路由器均不转发）**              |
| **net-id**  | **全****1**                            | **不可**           | **可以**             | **对****net-id****上的所有主机进行广播**                  |
| **127**     | **非全****0****或全****1****的任何数** | **可以**           | **可以**             | 用作本地软件环回测试之用                                  |

#### IP 地址的一些重要特点

1. IP 地址是一种分等级的地址结构。分两个等级的好处是：第一，IP 地址管理机构在分配 IP 地址时只分配网络号，而剩下的主机号则由得到该网络号的单位自行分配。这样就方便了 IP 地址的管理；第二，路由器仅根据目的主机所连接的网络号来转发分组（而不考虑目的主机号），这样就可以使路由表中的项目数大幅度减少，从而减小了路由表所占的存储空间
2. 实际上 IP 地址是标志一个主机（或路由器）和一条链路的接口。当一个主机同时连接到两个网络上时，该主机就必须同时具有两个相应的 IP 地址，其网络号 net-id 必须是不同的。这种主机称为多归属主机 (multihomed host)。由于一个路由器至少应当连接到两个网络（这样它才能将 IP 数据报从一个网络转发到另一个网络），因此一个路由器至少应当有两个不同的 IP 地址
3. 用转发器或网桥连接起来的若干个局域网仍为一个网络，因此这些局域网都具有同样的网络号 net-id
4. 所有分配到网络号 net-id 的网络，无论是范围很小的局域网，还是可能覆盖很大地理范围的广域网，都是平等的

![捕获23](E:\我的电脑\图片\学习\计算机网络\捕获23.PNG)

在同一个局域网上的主机或路由器的 IP 地址中的网络号必须是一样的，图中的网络号就是 IP 地址中的 net-id。路由器总是具有两个或两个以上的 IP 地址，路由器的每一个接口都有一个不同网络号的 IP 地址。两个路由器直接相连的接口处，可指明也可不指明 IP 地址。如指明 IP 地址，则这一段连线就构成了一种只包含一段线路的特殊“网络” ，现在常不指明 IP 地址

硬件地址（或物理地址）是数据链路层和物理层使用的地址；IP 地址是网络层和以上各层使用的地址，是一种逻辑地址（称 IP 地址是逻辑地址是因为 IP 地址是用软件实现的）

### 地址解析协议 ARP

ARP 的作用为从网络层使用的 IP 地址，解析出在数据链路层使用的硬件地址。不管网络层使用的是什么协议，在实际网络的链路上传送数据帧时，最终还是必须使用硬件地址。 每一个主机都设有一个 ARP 高速缓存 (ARP cache)，里面有所在的局域网上的各主机和路由器的 IP 地址到硬件地址的映射表，格式为 < IP address；MAC address；TTL >，TTL (Time To Live) 为地址映射有效时间

当主机 A 欲向本局域网上的某个主机 B 发送 IP 数据报时，就先在其 ARP 高速缓存中查看有无主机 B 的 IP 地址。如有，就可查出其对应的硬件地址，再将此硬件地址写入 MAC 帧，然后通过局域网将该 MAC 帧发往此硬件地址。如没有， ARP 进程在本局域网上广播发送一个 ARP 请求分组（路由器不转发ARP请求）。收到 ARP 响应分组后，将得到的 IP 地址到硬件地址的映射写入 ARP 高速缓存

ARP请求分组包含发送方硬件地址 / 发送方 IP 地址 / 目标方硬件地址(未知时填 0) / 目标方 IP 地址，ARP 响应分组包含发送方硬件地址 / 发送方 IP地址 / 目标方硬件地址 / 目标方 IP 地址，ARP 分组封装在物理网络的帧中传输

![捕获24](E:\我的电脑\图片\学习\计算机网络\捕获24.PNG)

ARP 是解决同一个局域网上的主机或路由器的 IP 地址和硬件地址的映射问题。如果所要找的主机和源主机不在同一个局域网上，那么就要通过 ARP 找到一个位于本局域网上的某个路由器的硬件地址，然后把分组发送给这个路由器，让这个路由器把分组转发给下一个网络。剩下的工作就由下一个网络来做。

从 IP 地址到硬件地址的解析是自动进行的，主机的用户对这种地址解析过程是不知道的。只要主机或路由器要和本网络上的另一个已知 IP 地址的主机或路由器进行通信，ARP 协议就会自动地将该 IP 地址解析为链路层所需要的硬件地址

#### ARP 高速缓存的作用

存放最近获得的 IP 地址到 MAC 地址的绑定，以减少 ARP 广播的数量。为了减少网络上的通信量，主机 A 在发送其 ARP 请求分组时，就将自己的 IP 地址到硬件地址的映射写入 ARP 请求分组。当主机 B 收到 A 的 ARP 请求分组时，就将主机 A 的这一地址映射写入主机 B 自己的 ARP 高速缓存中。这对主机 B 以后向 A 发送数据报时就更方便了。windows 下可以使用 arp –a 指令查看缓存映射

#### 传奇外挂携带的ARP木马攻击

原因：当局域网内使用外挂时，外挂携带的病毒会将该机器的MAC地址映射到网关的IP地址上，向局域网内大量发送ARP包，致同一网段地址内的其它机器误将其作为网关，掉线时内网是互通的，计算机却不能上网。

解决方法：在能上网时，进入MS-DOS窗口，输入命令：arp –a查看网关IP对应的正确MAC地址，将其记录，如果已不能上网，则先运行一次命令 arp –d 将 arp 缓存中的内容删空，计算机可暂时恢复上网，一旦能上网就立即将网络断掉，禁用网卡或拔掉网线，再运行 arp –a。如已有网关的正确MAC地址，在不能上网时，手工将网关IP和正确MAC绑定，可确保计算机不再被攻击影响。可在MS-DOS窗口下运行以下命令：arp –s 网关IP 网关MAC。

找出病毒计算机：如被攻击，用该命令查看，会发现该MAC已经被替换成攻击机器的MAC，将该MAC记录，以备查找。如果已有病毒计算机的MAC地址，可使用 NBTSCAN 软件找出网段内与该 MAC 地址对应的 IP，即病毒计算机的IP地址

### IP 数据报的格式

![捕获25](E:\我的电脑\图片\学习\计算机网络\捕获25.PNG)

IP 数据报由首部和数据两部分组成，首部的前一部分是固定长度，共 20 字节，是所有 IP 数据报必须具有的

- 版本——占 4 位，指 IP 协议的版本，目前的 IP 协议版本号为 4 (即 IPv4)
- 首部长度——占 4 位，可表示的最大数值是 15 个单位(一个单位为 4 字节)，因此 IP 的首部长度的最大值是 60 字节
- 区分服务——占 8 位，用来获得更好的服务。在旧标准中叫做服务类型，但实际上一直未被使用过。1998 年这个字段改名为区分服务。只有在使用区分服务（DiffServ）时，这个字段才起作用，在一般的情况下都不使用这个字段
- 总长度——占 16 位，指首部和数据之和的长度，单位为字节，因此数据报的最大长度为 65535 字节，总长度必须不超过最大传送单元 MTU
- 标识(identification) ——占 16 位，它是一个计数器，用来产生 IP 数据报的标识
- 标志(flag) ——占 3 位，目前只有前两位有意义。标志字段的最低位是 MF (More Fragment)。MF = 1 表示后面“还有分片”。MF = 0 表示最后一个分片。标志字段中间的一位是 DF (Don't Fragment) 。只有当 DF = 0 时才允许分片
- 片偏移—— 占13 位，指出：较长的分组在分片后某片在原分组中的相对位置，片偏移以 8 个字节为偏移单位
- 生存时间——占8 位，记为 TTL (Time To Live)，指示数据报在网络中可通过的路由器数的最大值
- 协议——占8 位，指出此数据报携带的数据使用何种协议，以便目的主机的 IP 层将数据部分上交给那个处理过程。P 协议支持多种协议，IP 数据报可以封装多种协议 PDU
- 首部检验和——占16 位，只检验数据报的首部，不检验数据部分。这里不采用 CRC 检验码而采用简单的计算方法，采用 16 位二进制反码求和算法
- IP 首部的可变部分就是一个选项字段，用来支持排错、测量以及安全等措施，内容很丰富。选项字段的长度可变，从 1 个字节到 40 个字节不等，取决于所选择的项目。增加首部的可变部分是为了增加 IP 数据报的功能，但这同时也使得 IP 数据报的首部长度成为可变的。这就增加了每一个路由器处理数据报的开销。实际上这些选项很少被使用

![捕获27](E:\我的电脑\图片\学习\计算机网络\捕获27.PNG)

![捕获28](E:\我的电脑\图片\学习\计算机网络\捕获28.PNG)

一数据报的总长度为 3820 字节，其数据部分的长度为 3800 字节（使用固定首部），需要分片为长度不超过 1420 字节的数据报片。因固定首部长度为 20 字节，因此每个数据报片的数据部分长度不能超过 1400 字节。于是分为 3 个数据报片，其数据部分的长度分别为 1400、1400 和 1000 字节。原始数据报首部被复制为各数据报片的首部，但必须修改有关字段的值

![捕获26](E:\我的电脑\图片\学习\计算机网络\捕获26.PNG)

IP 数据报首部中与分片有关的字段中的数值

|                   | **总长度** | **标识**  | **MF** | **DF** | **片偏移** |
| ----------------- | ---------- | --------- | ------ | ------ | ---------- |
| **原始数据报**    | **3820**   | **12345** | 0      | 0      | 0          |
| **数据报片****1** | **1420**   | 12345     | 1      | **0**  | 0          |
| **数据报片****2** | **1420**   | 12345     | 1      | **0**  | 175        |
| **数据报片****3** | **1020**   | 12345     | 0      | **0**  | **350**    |

### IP 层转发分组的流程

按主机所在的网络地址来制作路由表，在路由表中，对每一条路由，最主要的是目的网络地址和下一跳地址。根据目的网络地址就能确定下一跳路由器，这样做的结果是：IP 数据报最终一定可以找到目的主机所在目的网络上的路由器（可能要通过多次的间接交付），只有到达最后一个路由器时，才试图向目的主机进行直接交付

IP 数据报的首部中没有地方可以用来指明“下一跳路由器的 IP 地址”。当路由器收到待转发的数据报，不是将下一跳路由器的 IP 地址填入 IP 数据报，而是送交下层的网络接口软件。网络接口软件使用 ARP 负责将下一跳路由器的 IP 地址转换成硬件地址，并将此硬件地址放在链路层的 MAC 帧的首部，然后根据这个硬件地址找到下一跳路由器

#### 特定主机路由和默认路由

虽然互联网所有的分组转发都是基于目的主机所在的网络，但在大多数情况下都允许有这样的特例，即为特定的目的主机指明一个路由。采用特定主机路由可使网络管理人员能更方便地控制网络和测试网络，同时也可在需要考虑某种安全问题时采用这种特定主机路由。

路由器还可采用默认路由(default route)以减少路由表所占用的空间和搜索路由表所用的时间。这种转发方式在一个网络只有很少的对外连接时是很有用的，默认路由在主机发送 IP 数据报时往往更能显示出它的好处。如果一个主机连接在一个小网络上，而这个网络只用一个路由器和互联网连接，那么在这种情况下使用默认路由是非常合适的

![捕获29](E:\我的电脑\图片\学习\计算机网络\捕获29.PNG)

#### 路由器分组转发算法

1. 从数据报的首部提取目的主机的 IP 地址 D, 得出目的网络地址为 N
2. 若网络 N 与此路由器直接相连，则把数据报直接交付目的主机 D；否则是间接交付，执行(3)
3. 若路由表中有目的地址为 D 的特定主机路由，则把数据报传送给路由表中所指明的下一跳路由器；否则，执行(4)
4. 若路由表中有到达网络 N 的路由，则把数据报传送给路由表指明的下一跳路由器；否则，执行(5)
5. 若路由表中有一个默认路由，则把数据报传送给路由表中所指明的默认路由器；否则，执行(6)
6. 报告转发分组出错

路由表没有给分组指明到某个网络的完整路径，路由表指出，到某个网络应当先到某个路由器（即下一跳路由器）。在到达下一跳路由器后，再继续查找其路由表，知道再下一步应当到哪一个路由器。这样一步一步地查找下去，直到最后到达目的网络

## 4.3  划分子网和构造超网

### 划分子网

在 IP 地址中又增加了一个“子网号字段”，使两级的 IP 地址变成为三级的 IP 地址，这种做法叫作划分子网 (subnetting) 。
划分子网已成为互联网的正式标准协议。划分子网纯属一个单位内部的事情，单位对外仍然表现为没有划分子网的网络。
从主机号借用若干个位作为子网号 subnet-id，而主机号 host-id 也就相应减少了若干个位

凡是从其他网络发送给本单位某个主机的 IP 数据报，仍然是根据 IP 数据报的目的网络号 net-id，先找到连接在本单位网络上的路由器。然后此路由器在收到 IP 数据报后，再按目的网络号 net-id 和子网号 subnet-id 找到目的子网。最后就将 IP 数据报直接交付目的主机

**优点**：减少了 IP 地址的浪费；使网络的组织更加灵活；更便于维护和管理；**缺点**：划分子网增加了灵活性，但却减少了能够连接在网络上的主机总数

### 子网掩码

从一个 IP 数据报的首部并无法判断源主机或目的主机所连接的网络是否进行了子网划分。使用子网掩码(subnet mask)可以找出 IP 地址中的子网部分。子网掩码长度= 32 位，某位 = 1：IP地址中的对应位为网络号和子网号，某位＝0：IP地址中的对应位为主机。网络地址的计算：(IP 地址) AND (子网掩码) =网络地址

各类地址的子网掩码

![捕获18](https://zcayo.oss-cn-beijing.aliyuncs.com/%E5%9B%BE%E7%89%87/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E6%8D%95%E8%8E%B718.PNG)

子网掩码是一个网络或一个子网的重要属性。路由器在和相邻路由器交换路由信息时，必须把自己所在网络（或子网）的子网掩码告诉相邻路由器。路由器的路由表中的每一个项目，除了要给出目的网络地址外，还必须同时给出该网络的子网掩码。若一个路由器连接在两个子网上就拥有两个网络地址和两个子网掩码

有固定长度子网和变长子网两种子网划分方法。在采用固定长度子网时，所划分的所有子网的子网掩码都是相同的。
虽然根据已成为互联网标准协议的RFC 950文档，子网号不能为全1或全0，但随着无分类域间路由选择CIDR的广泛使用，现在全1和全0的子网号也可以使用了，但一定要谨慎使用，确认你的路由器所用的路由选择软件是否支持全0或全1的子网号这种较新的用法

![捕获19](https://zcayo.oss-cn-beijing.aliyuncs.com/%E5%9B%BE%E7%89%87/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E6%8D%95%E8%8E%B719.PNG)

确定子网位数有两种思路：1.需要划分出的子网个数，2.每个子网需容纳的主机个数

#### 一般子网的规划设计

在组建企业网，对企业网的子网结构进行规划设计时，主要考虑下面几个步骤：

- 第一步，确定企业的子网数。考虑网络的分布位置（建筑物和楼层的数目）、部门数、每一个子网中的主机数目等等。为了便于子网掩码的运算，最好使子网数目为2的若干次方减2，即2n－2，例如：0，2，6，14，30，…。子网数目为0，相当于不划分子网
- 第二步，计算子网掩码。默认子网掩码中1的位数，加上定义子网时的位数，就能得出子网掩码中1的总位数。32位减去1的位数，剩下的位数就是0的位数
- 第三步，计算每一个子网的地址范围。可以从第一个子网着手，也可以从最后一个子网着手来确定子网的地址范围。

例如，从第一个子网开始，首先确定第一个子网的第一个地址，然后加上子网中的地址数减1，得出最后一个地址；第一个子网的最后一个地址加1，就可以计算出第二个子网的第一个地址；加上第二个子网的地址数减1，就得到第二个子网的最后一个地址。重复上述过程，即可计算出每一个子网的地址范围

主机部分全0，会被认为是网络地址；主机部分全1，会被认为是广播地址。不同的子网掩码得出相同的网络地址，但不同的掩码的效果是不同的

#### 在划分子网情况下路由器转发分组的算法

1. 从收到的分组的首部提取目的 IP 地址 D
2. 先用各网络的子网掩码和 D 逐位相“与”，看是否和相应的网络地址匹配。若匹配，则将分组直接交付。否则就是间接交付，执行 (3)
3. 若路由表中有目的地址为 D 的特定主机路由，则将分组传送给指明的下一跳路由器；否则，执行 (4)
4. 对路由表中的每一行，将子网掩码和 D 逐位相“与”。若结果与该行的目的网络地址匹配，则将分组传送给该行指明的下一跳路由器；否则，执行 (5)
5. 若路由表中有一个默认路由，则将分组传送给路由表中所指明的默认路由器；否则，执行 (6)
6. 报告转发分组出错

![捕获20](https://zcayo.oss-cn-beijing.aliyuncs.com/%E5%9B%BE%E7%89%87/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E6%8D%95%E8%8E%B720.PNG)

1.  H1 首先检查主机 128.30.33.138 是否连接在本网络上，如果是，则直接交付；否则，就送交路由器 R1，并逐项查找路由表

2. 主机 H1 首先将本子网的子网掩码 255.255.255.128与分组的 IP 地址 128.30.33.138 逐比特相“与”(AND 操作)

   255.255.255.128 AND 128. 30. 33.138 = 128.  30.  33.128，与H1 的网络地址不一致

3. 因此 H1 必须把分组传送到路由器 R1然后逐项查找路由表

   （1）路由器 R1 收到分组后就用路由表中第 1 个项目的子网掩码和 128.30.33.138 逐比特 AND 操作

   ​	255.255.255.128 AND 128.30.33.138 = 128.30.33.128，与路由表中的 128.30.33.0 不一致

   （2）用路由表中第 2 个项目的子网掩码和 128.30.33.138 逐比特 AND 操作

   ​	255.255.255.128 AND 128.30.33.138 = 128.30.33.128，匹配，表明子网 2 就是收到的分组所要寻找的目的网络

### 无分类编址 CIDR

使用变长子网掩码 VLSM (Variable Length Subnet Mask)可进一步提高 IP 地址资源的利用率，在 VLSM 的基础上又进一步研究出无分类编址方法，它的正式名字是无分类域间路由选择 CIDR (Classless Inter-Domain Routing)。CIDR 消除了传统的 A 类、B 类和 C 类地址以及划分子网的概念，因而可以更加有效地分配 IPv4 的地址空间。CIDR使用各种长度的“网络前缀”(network-prefix)来代替分类地址中的网络号和子网号，IP 地址从三级编址（使用子网掩码）又回到了两级编址

#### 无分类的两级编址的记法

IP地址 ::= {<网络前缀>, <主机号>} ，CIDR 使用“斜线记法”(slash notation)，它又称为 CIDR 记法，即在 IP 地址面加上一个斜线“/”，然后写上网络前缀所占的位数（这个数值对应于三级编址中子网掩码中 1 的个数）。CIDR 把网络前缀都相同的连续的 IP 地址组成“CIDR 地址块”，在不需要指出地址块的起始地址时，也可将这样的地址块简称为“/20 地址块”。

例如： 128.14.32.0/20 表示的地址块共有 212 个地址（因为斜线后面的 20 是网络前缀的位数，所以这个地址的主机号是 12 位）。这个地址块的起始地址是 128.14.32.0，128.14.32.0/20 地址块的最小地址：128.14.32.0，128.14.32.0/20 地址块的最大地址：128.14.47.255。全 0 和全 1 的主机号地址一般不使用

CIDR 记法的其他形式：10.0.0.0/10 可简写为 10/10，也就是把点分十进制中低位连续的 0 省略；网络前缀的后面加一个星号 * 的表示方法，如 00001010 00*，在星号 * 之前是网络前缀，而星号 * 表示 IP 地址中的主机号，可以是任意值

一个 CIDR 地址块可以表示很多地址，这种地址的聚合常称为路由聚合，它使得路由表中的一个项目可以表示很多个（例如上千个）原来传统分类地址的路由，路由聚合也称为构成超网 (supernetting)。路由聚合有利于减少路由器之间的路由选择信息的交换，从而提高了整个互联网的性能。CIDR 虽然不使用子网了，但仍然使用“掩码”这一名词（但不叫子网掩码）

#### 常用的 CIDR 地址块

![捕获21](https://zcayo.oss-cn-beijing.aliyuncs.com/%E5%9B%BE%E7%89%87/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E6%8D%95%E8%8E%B721.PNG)

前缀长度不超过 23 位的 CIDR 地址块都包含了多个 C  类地址，这些 C 类地址合起来就构成了超网。CIDR 地址块中的地址数一定是 2 的整数次幂。网络前缀越短，其地址块所包含的地址数就越多，而在三级结构的IP地址中，划分子网是使网络前缀变长。CIDR 的一个好处是：可以更加有效地分配 IPv4 的地址空间，可根据客户的需要分配适当大小的 CIDR 地址块

![捕获22](https://zcayo.oss-cn-beijing.aliyuncs.com/%E5%9B%BE%E7%89%87/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E6%8D%95%E8%8E%B722.PNG)

#### 最长前缀匹配

使用 CIDR 时，路由表中的每个项目由“网络前缀”和“下一跳地址”组成，在查找路由表时可能会得到不止一个匹配结果。 
应当从匹配结果中选择具有最长网络前缀的路由：最长前缀匹配 (longest-prefix matching)，最长前缀匹配又称为最长匹配或最佳匹配。网络前缀越长，其地址块就越小，因而路由就越具体 。

## 4.4  网际控制报文协议 ICMP

为了更有效地转发 IP 数据报和提高交付成功的机会，在网际层使用了网际控制报文协议 ICMP (Internet Control Message Protocol)  。ICMP 是互联网的标准协议，允许主机或路由器报告差错情况和提供有关异常情况的报告。但 ICMP 不是高层协议（看起来好像是高层协议，因为 ICMP 报文是装在 IP 数据报中，作为其中的数据部分），而是 IP 层的协议。

### ICMP报文的格式   

![捕获](https://zcayo.oss-cn-beijing.aliyuncs.com/%E5%9B%BE%E7%89%87/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E6%8D%95%E8%8E%B76.PNG)

​     封装成帧(framing)就是在一段数据的前后分别添加首部和尾部，然后就构成了一个帧，用来确定帧的界限  

### ICMP的应用举例  

1. PING (Packet InterNet Groper) 

   PING 用来测试两个主机之间的连通性，使用了 ICMP 回送请求与回送回答报文，是应用层直接使用网络层的例子，它没有通过运输层的 TCP 或 UDP。比如`ping mail.sina.com.cn`

2. Traceroute  

   tracert 用来跟踪一个分组从源点到终点的路径，获得到目的主机的路由信息。它利用 IP 数据报中的 TTL 字段和 ICMP 时间超过差错报告实现对从到终点的的跟踪。比如`tracert mail.sina.com.cn`

## 4.5 互联网的路由选择协议  

### 自治系统 AS

自治系统(Autonomous System)是指使用统一内部路由协议的一组网络。如果成员单位的网络路由器准备采用EGP（Exterior Gateway Protocol） 、BGP（Border Gateway Protocol）或 IDRP（OSI Inter-Domain Routing Protocol）协议，可以申请 AS 号码  。自治系统之间的路由选择也叫作域间路由选择 (interdomain routing)，在自治系统内部的路由选择叫作域内路由选择 (intradomain routing) 

- 内部网关协议 IGP (Interior Gateway Protocol) 是在一个自治系统内部使用的路由选择协议，目前这类路由选择协议使用得最多，如 RIP 和 OSPF 协议。
- 外部网关协议 EGP (External Gateway Protocol) ，若源站和目的站处在不同的自治系统中，当数据报传到一个自治系统的边界时，就需要使用一种协议将路由选择信息传递到另一个自治系统中，这样的协议就是外部网关协议 EGP。在外部网关协议中目前使用最多的是 BGP-4 

注意：应当把“路由器”和“网关”这两个术语当作同义词

### 内部网关协议 RIP  

​     路由信息协议 RIP (Routing Information Protocol) 是一种分布式的、基于距离向量的路由选择协议，要求网络中的每一个路由器都要维护从它自己到其他每一个目的网络的距离记录  

#### 关于“距离”的定义

从一个路由器到直接连接的网络的距离定义为 1，从一个路由器到非直接连接的网络的距离定义为所经过的路由器数加 1。RIP 协议中的“距离”也称为“跳数”(hop count)，每经过一个路由器，跳数就加 1，这里的“距离”实际上指的是“最短距离  ”。RIP 认为一个好的路由就是它通过的路由器的数目少，即“距离短”。RIP 允许一条路径最多只能包含 15 个路由器，“距离”的最大值为 16 时即相当于不可达，可见 RIP 只适用于小型互联网。RIP 不能在两个网络之间同时使用多条路由，选择一个具有最少路由器的路由（即最短路由），哪怕还存在另一条高速低时延但路由器较多的路由

#### RIP 协议的特点   

仅和相邻路由器交换信息，交换的信息是当前本路由器所知道的全部信息，即自己的路由表。按固定的时间间隔交换路由信息，例如每隔 30 秒。当网络拓扑发生变化时，路由器也及时向相邻路由器通告拓扑变化后的路由息  

#### 路由表的建立

路由器在刚刚开始工作时，只知道到直接连接的网络的距离（此距离定义为1），它的路由表是空的。以后，每一个路由器也只和数目非常有限的相邻路由器交换并更新路由信息。经过若干次更新后，所有的路由器最终都会知道到达本自治系统中任何一个网络的最短距离和下一跳路由器的地址。RIP 协议的收敛 (convergence) 过程较快，“收敛”就是在自治系统中所有的结点都得到正确的路由选择信息的过程  

#### 距离向量算法 

路由器收到相邻路由器（其地址为 X）的一个 RIP 报文：

1. 先修改此 RIP 报文中的所有项目：把“下一跳”字段中的地址都改为 X，并把所有的“距离”字段的值加 1。

2. 对修改后的 RIP 报文中的每一个项目，重复以下步骤：

   项目中的目的网络不在路由表中，则把该项目加到路由表中。

   ​    否则

   ​        若下一跳字段给出的路由器地址是同样的，则把收到的项目替换原路由表中的项目。

   ​            否则 

   ​               若收到项目中的距离小于路由表中的距离，则进行更新。

   ​                  否则，什么也不做。

3. 3 分钟还没有收到相邻路由器的更新路由表，则把此相邻路由器记为不可达路由器，即将距离置为 16（表示不可达）。

4. 返回

![捕获1](https://zcayo.oss-cn-beijing.aliyuncs.com/%E5%9B%BE%E7%89%87/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E6%8D%95%E8%8E%B77.PNG)

#### RIP 协议的优缺点   

优点：实现简单，开销较小。

缺点：RIP 限制了网络的规模，它能使用的最大距离为 15（16 表示不可达）；路由器之间交换的路由信息是路由器中的完整路由表，因而随着网络规模的扩大，开销也就增加；“坏消息传播得慢”，使更新过程的收敛时间过长

### 内部网关协议 OSPF  

开放最短路径优先 OSPF (Open Shortest Path First)  ，“开放”表明 OSPF 协议不是受某一家厂商控制，而是公开发表的。“最短路径优先”是因为使用了 Dijkstra 提出的最短路径算法 SPF，采用分布式的链路状态 link state protocol)

 “链路状态”就是说明本路由器都和哪些路由器相邻，以及该链路的“度量”(metric)  ，只有当链路状态发生变化时，路由器才用洪泛法向所有路由器发送信息，发送的信息就是与本路由器相邻的所有路由器的链路状态，但这只是路由器所知道的部分信息  。

由于各路由器之间频繁地交换链路状态信息，因此所有的路由器最终都能建立一个链路状态数据库(link-state database)。这个数据库实际上就是全网的拓扑结构图，它在全网范围内是一致的。OSPF 的链路状态数据库能**较快地进行更新**（重要优点），使各个路由器能及时更新其路由表  

#### OSPF 的区域   

为了使 OSPF 能够用于规模很大的网络，OSPF 将一个自治系统再划分为若干个更小的范围，叫作区域。每一个区域都有一个 32 位的区域标识符（用点分十进制表示）。区域也不能太大，在一个区域内的路由器最好不超过 200 

划分区域的好处就是将利用洪泛法交换链路状态信息的范围局限于每一个区域而不是整个的自治系统，这就减少了整个网络上的通信量。在一个区域内部的路由器只知道本区域的完整网络拓扑，而不知道其他区域的网络拓扑的情况。

OSPF 使用层次结构的区域划分。在上层的区域叫作主干区域 (backbone area)，它的标识符规定为 0.0.0.0 ，是用来连通其他在下层的区域。处于两个区域之间的路由器叫做区域边界路由器

### 外部网关协议 BGP  

BGP（Border Gateway Protocol）是不同自治系统的路由器之间交换路由信息的协议  。可以将 BGP-4 简写为 BGP  。边界网关协议 BGP 只能是力求寻找一条能够到达目的网络且比较好的路由（不能兜圈子），而并非要寻找一条最佳路由  。

每一个自治系统的管理员要选择至少一个路由器作为该自治系统的“ BGP 发言人” (BGP speaker) 。一般说来， 两个BGP 发言人都是通过一个共享网络连接在一起的，而 BGP 发言人往往就是 BGP 边界路由器，但也可以不是 BGP 边界路由器  

#### BGP 交换路由信息  

一个 BGP 发言人与其他自治系统中的 BGP 发言人要交换路由信息，就要先建立 TCP 连接，然后在此连接上交换 BGP 报文以建立 BGP 会话(session)，利用 BGP 会话交换路由信息。使用 TCP 连接能提供可靠的服务，也简化了路由选择协议。使用 TCP 连接交换路由信息的两个 BGP 发言人，彼此成为对方的邻站(neighbor)或对等站(peer)  。

BGP 所交换的网络可达性的信息就是要到达某个网络所要经过的一系列 AS 。当 BGP 发言人互相交换了网络可达性的信息后，各 BGP 发言人就根据所采用的策略从收到的路由信息中找出到达各 AS 的较好路由。

#### 路由器的构成  

路由器是一种典型的网络层设备，也是互联网中的关键设备  。主要作用是连通不同的网络和选择信息传送的线路。选择通畅快捷的近路，能大大提高通信速度，减轻网络系统通信负荷，节约网络系统资源，提高网络系统畅通率，从而让网络系统发挥出更大的效益来。

路由器是一种具有多个输入端口和多个输出端口的专用计算机，其任务是转发分组。也就是说，将路由器某个输入端口收到的分组，按照分组要去的目的地（即目的网络），把该分组从路由器的某个合适的输出端口转发给下一跳路由器。下一跳路由器也按照这种方法处理分组，直到该分组到达终点为止。 路由器的转发分组正是网络层的主要工作

![捕获2](https://zcayo.oss-cn-beijing.aliyuncs.com/%E5%9B%BE%E7%89%87/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E6%8D%95%E8%8E%B78.PNG)

输出端口从交换结构接收分组，然后把它们发送到路由器外面的线路上。在网络层的处理模块中设有一个缓冲区（队列）。当交换结构传送过来的分组的速率超过输出链路的发送速率时，来不及发送的分组就必须暂时存放在这个队列中。数据链路层处理模块将分组加上链路层的首部和尾部，交给物理层后发送到外部线路

![捕获3](https://zcayo.oss-cn-beijing.aliyuncs.com/%E5%9B%BE%E7%89%87/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E6%8D%95%E8%8E%B79.PNG)

若路由器处理分组的速率赶不上分组进入队列的速率，则队列的存储空间最终必定减少到零，这就使后面再进入队列的分组由于没有存储空间而只能被丢弃。路由器中的输入或输出队列产生溢出是造成分组丢失的重要原因

## 4.6  IPv6

互联网经过几十年的飞速发展，到2011年2月，IPv4 的 32 位地址已经耗尽。解决 IP 地址耗尽的根本措施就是采用具有更大地址空间的新版本的 IP，即 IPv6。IPv6 仍支持无连接的传送，但将协议数据单元 PDU 称为分组

所引进的主要变化如下：

- 更大的地址空间。IPv6 将地址从 IPv4 的 32 位 增大到了 128 位。 
- 扩展的地址层次结构。 
- 灵活的首部格式。 IPv6 定义了许多可选的扩展首部。
- 改进的选项。 IPv6 允许数据报包含有选项的控制信息，其选项放在有效载荷中
- 允许协议继续扩充。 
- 支持即插即用（即自动配置）。因此 IPv6 不需要使用 DHCP。
- 支持资源的预分配。  IPv6 支持实时视像等要求，保证一定的带宽和时延的应用。
- IPv6 首部改为 8 字节对齐。首部长度必须是 8 字节的整数倍，原来的 IPv4 首部是 4 字节对齐

### IPv6 数据报的一般形式

IPv6数据报由两大部分组成：基本首部 (base header)和有效载荷 (payload)。有效载荷也称为净负荷，它允许有零个或多个扩展首部(extension header)，再后面是数据部分

![捕获10](https://zcayo.oss-cn-beijing.aliyuncs.com/%E5%9B%BE%E7%89%87/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E6%8D%95%E8%8E%B710.PNG)

#### IPv6 数据报的基本首部

把首部中不必要的功能取消了，使得 IPv6 首部的字段数减少到只有 8 个。IPv6 对首部中的某些字段进行了如下的更改：

- 取消了首部长度字段，因为首部长度是固定的 40 字节；
- 取消了服务类型字段；
- 取消了总长度字段，改用有效载荷长度字段；
- 把 TTL 字段改称为跳数限制字段；
- 取消了协议字段，改用下一个首部字段；
- 取消了检验和字段；
- 取消了选项字段，而用扩展首部来实现选项功能

![捕获11](https://zcayo.oss-cn-beijing.aliyuncs.com/%E5%9B%BE%E7%89%87/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E6%8D%95%E8%8E%B711.PNG)

- 版本(version)—— 4 位。它指明了协议的版本，对 IPv6 该字段总是 6
- 通信量类(traffic class)—— 8 位。这是为了区分不同的 IPv6 数据报的类别或优先级。目前正在进行不同的通信量类性能的实验
- 流标号(flow label)—— 20 位。 “流”是互联网络上从特定源点到特定终点的一系列数据报， “流”所经过的路径上的路由器都保证指明的服务质量。所有属于同一个流的数据报都具有同样的流标号
- 有效载荷长度(payload length)—— 16 位。它指明 IPv6 数据报除基本首部以外的字节数（所有扩展首部都算在有效载荷之内），其最大值是 64 KB
- 下一个首部(next header)—— 8 位。它相当于 IPv4 的协议字段或可选字段
- 跳数限制(hop limit)—— 8 位。源站在数据报发出时即设定跳数限制。路由器在转发数据报时将跳数限制字段中的值减 1。当跳数限制的值为零时，就要将此数据报丢弃
- 源地址—— 128 位。是数据报的发送站的 IP 地址
- 目的地址—— 128 位。是数据报的接收站的 IP 地址

### IPv6 数据报的拓展首部

IPv6 把原来 IPv4 首部中选项的功能都放在扩展首部中，并将扩展首部留给路径两端的源站和目的站的主机来处理。数据报途中经过的路由器都不处理这些扩展首部（只有一个首部例外，即逐跳选项扩展首部）。这样就大大提高了路由器的处理效率。

在 RFC 2460 中定义了六种扩展首部：(1) 逐跳选项；(2) 路由选择；(3) 分片；(4) 鉴别；(5) 封装安全有效载荷；(6) 目的站选项 。每一个扩展首部都由若干个字段组成，它们的长度也各不相同，但所有扩展首部的第一个字段都是8位的“下一个首部”字段，此字段的值指出了在该扩展首部后面的字段是什么

### IPv6 的地址

IPv6 数据报的目的地址可以是以下三种基本类型地址之一：(1) 单播 (unicast)：传统的点对点通信；(2) 多播 (multicast)：一点对多点的通信；(3) 任播 (anycast)：这是 IPv6 增加的一种类型。任播的目的站是一组计算机，但数据报在交付时只交付其中的一个，通常是距离最近的一个。

IPv6 将实现 IPv6 的主机和路由器均称为结点，一个结点就可能有多个与链路相连的接口。IPv6 地址是分配给结点上面的接口的，一个接口可以有多个单播地址，其中的任何一个地址都可以当作到达该结点的目的地址，即一个结点接口的单播地址可用来唯一地标志该结点

#### 冒号十六进制记法

在IPv6中，每个地址占 128 位，地址空间大于 3.4 x 1038 。IPv6 使用冒号十六进制记法，每个 16 位的值用十六进制值表示，各值之间用冒号分隔。例如：`68E6:8C64:FFFF:FFFF:0:1180:960A:FFFF`。

- 在十六进制记法中，允许把数字前面的0省略，例如把0000中的前三个0省略，写成1个0。
- 冒号十六进制记法可以允许零压缩，即一连串连续的零可以为一对冒号所取代，例如`FF05:0:0:0:0:0:0:B3`可压缩为`FF05::B3`，但是在任一地址中只能使用一次零压缩
- 冒号十六进制记法可结合使用点分十进制记法的后缀，例如：`0:0:0:0:0:0:128.10.2.1`再使用零压缩即可得出`::128.10.2.1`
- CIDR 的斜线表示法仍然可用，例如：60 位的前缀`12AB00000000CD3`可记为：`12AB:0000:0000:CD30:0000:0000:0000:0000/60`或 `12AB::CD30:0:0:0:0/60` （零压缩）或`12AB:0:0:CD30::/60`（零压缩）

### IPv6 地址分类

| **地址类型**         | 二进制前缀                             |                                                              |
| -------------------- | -------------------------------------- | ------------------------------------------------------------ |
| 未指明地址           | 00…0（128位），可记为 ::/128           | 这个地址只能为还没有配置到一个标准的 IP 地址的主机当作源地址使用，这类地址仅此一个 |
| **环回地址**         | 00…1（128位），可记为 ::1/128          | 作用和IPv4的环回地址一样，这类地址也是仅此一个               |
| **多播地址**         | 11111111（8位），可记为 FF00::/8       | 功能和 IPv4 的一样，这类地址占 IPv6 地址总数的 1/256         |
| **本地链路单播地址** | 1111111010（10位）, 可记为 FE80::/10   | 有些单位的网络使用 TCP/IP 协议，但并没有连接到互联网上。连接在这样的网络上的主机都可以使用这种本地地址进行通信，但不能和互联网上的其他主机通信。这类地址占 IPv6 地址总数的 1/1024 |
| **全球单播地址**     | （除上述四种外，所有其他的二进制前缀） | IPv6 的这一类单播地址是使用得最多的一类。曾提出过多种方案来进一步划分这128位的单播地址 |

IPv6 单播地址的几种划分方法

![捕获12](https://zcayo.oss-cn-beijing.aliyuncs.com/%E5%9B%BE%E7%89%87/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E6%8D%95%E8%8E%B712.PNG)

###  从 IPv4 向 IPv6 过渡

向 IPv6 过渡只能采用逐步演进的办法，同时，还必须使新安装的 IPv6 系统能够向后兼容：IPv6 系统必须能够接收和转发 IPv4 分组，并且能够为 IPv4 分组选择路由。两种向 IPv6 过渡的策略：使用双协议栈和使用隧道技术

#### 双协议栈

双协议栈(dual stack)是指在完全过渡到 IPv6 之前，使一部分主机（或路由器）装有两个协议栈，一个 IPv4 和一个 IPv6。 双协议栈的主机（或路由器）记为 IPv6/IPv4，表明它同时具有两种 IP 地址：一个 IPv6 地址和一个 IPv4 地址。
双协议栈主机在和 IPv6 主机通信时是采用 IPv6 地址，而和 IPv4 主机通信时就采用 IPv4 地址。根据 DNS 返回的地址类型可以确定使用 IPv4 地址还是 IPv6 地址

#### 隧道技术

在 IPv6 数据报要进入IPv4网络时，把 IPv6 数据报封装成为 IPv4 数据报，整个的 IPv6 数据报变成了 IPv4 数据报的数据部分。当 IPv4 数据报离开 IPv4 网络中的隧道时，再把数据部分（即原来的 IPv6 数据报）交给主机的 IPv6 协议栈

![捕获13](https://zcayo.oss-cn-beijing.aliyuncs.com/%E5%9B%BE%E7%89%87/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E6%8D%95%E8%8E%B713.PNG)

## 4.7  IP 多播

多播可大大节约网络资源。比如采用单播方式，向 90 台主机传送同样的视频节目需要发送 90 个单播，采用多播方式，
只需发送一次到多播组，路由器复制分组。局域网具有硬件多播功能，不需要复制分组。当多播组的主机数很大时（如成千上万个），采用多播方式就可明显地减轻网络中各种资源的消耗

### IP 多播、多播 IP 地址和多播数据报

在互联网上进行多播就叫作 IP 多播，互联网范围的多播要靠路由器来实现，能够运行多播协议的路由器称为多播路由器(multicast router)，当然它也可以转发普通的单播IP数据报。虚拟的多播主干网MBONE (Multicast Backbone On the InterNEt)。

IP 多播 (multicast，以前曾译为组播) 的目的是为了更好第支持一对多通信。一对多通信就是一个源点发送到许多个终点，例如，实时信息的交付（如新闻、股市行情等），软件更新，交互式会议及其他多媒体通信

IP 多播所传送的分组需要使用多播 IP 地址，在多播数据报的目的地址写入的是多播组的标识符，多播组的标识符就是 IP 地址中的 D 类地址（多播地址），每一个D类地址标志一个多播组。多播地址只能用于目的地址，不能用于源地址

多播数据报和一般的 IP 数据报的区别就是它使用 D 类 IP 地址作为目的地址，并且首部中的协议字段值是2，表明使用网际组管理协议 IGMP。
多播数据报也是“尽最大努力交付”，不保证一定能够交付多播组内的所有成员。
对多播数据报不产生 ICMP 差错报文。因此，若在 PING 命令后面键入多播地址，将永远不会收到响应

### 在局域网上进行硬件多播

互联网号码指派管理局 IANA 拥有的以太网地址块的高 24 位为 00-00-5E，因此 TCP/IP 协议使用的以太网多播地址块的范围是从 00-00-5E-00-00-00 到  00-00-5E-FF-FF-FF 。不难看出，在每一个地址中，只有23位可用作多播。D 类 IP 地址可供分配的有 28 位，在这 28 位中的前 5 位不能用来构成以太网硬件地址

D 类 IP 地址与以太网多播地址的映射关系

![捕获14](https://zcayo.oss-cn-beijing.aliyuncs.com/%E5%9B%BE%E7%89%87/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E6%8D%95%E8%8E%B714.PNG)

由于多播IP地址与以太网硬件地址的映射关系不是唯一的，因此收到多播数据报的主机，还要在 IP 层利用软件进行过滤，把不是本主机要接收的数据报丢弃

### 网际组管理协议 IGMP 和多播路由选择协议

为了使路由器知道多播组成员的信息，需要利用网际组管理协议 IGMP (Internet Group Management Protocol)。连接在局域网上的多播路由器还必须和互联网上的其他多播路由器协同工作，以便把多播数据报用最小代价传送给所有的组成员。这就需要使用多播路由选择协议

IGMP 并非在互联网范围内对所有多播组成员进行管理的协议。IGMP 不知道 IP 多播组包含的成员数，也不知道这些成员都分布在哪些网络上。IGMP 协议是让连接在本地局域网上的多播路由器知道本局域网上是否有主机（严格讲，是主机上的某个进程）参加或退出了某个多播组。

和 ICMP 相似，IGMP 使用 IP 数据报传递其报文（即 IGMP 报文加上 IP 首部构成 IP 数据报），但它也向 IP 提供服务。因此，我们不把 IGMP 看成是一个单独的协议，而是属于整个网际协议 IP 的一个组成部分

多播路由选择协议比单播路由选择协议复杂得多。多播转发必须动态地适应多播组成员的变化（这时网络拓扑并未发生变化）。请注意，单播路由选择通常是在网络拓扑发生变化时才需要更新路由。多播路由器在转发多播数据报时，不能仅仅根据多播数据报中的目的地址，而是还要考虑这个多播数据报从什么地方来和要到什么地方去。 多播数据报可以由没有加入多播组的主机发出，也可以通过没有组成员接入的网络

## 4.8 虚拟专用网 VPN和网络地址转换 NAT

由于 IP 地址的紧缺，一个机构能够申请到的IP地址数往往远小于本机构所拥有的主机数。假定在一个机构内部的计算机通信也是采用 TCP/IP 协议，那么从原则上讲，对于这些仅在机构内部使用的计算机就可以由本机构自行分配其 IP 地址。本地地址是仅在机构内部使用的 IP 地址，可以由本机构自行分配，而不需要向互联网的管理机构申请。而全球地址是全球唯一的 IP 地址，必须向互联网的管理机构申请。

问题：在内部使用的本地地址就有可能和互联网中某个 IP 地址重合，这样就会出现地址的二义性问题。解决：RFC 1918指明了一些专用地址 (private address)。专用地址只能用作本地地址而不能用作全球地址。在互联网中的所有路由器，对目的地址是专用地址的数据报一律不进行转发

RFC 1918 指明的三个专用 IP 地址

1. 10.0.0.0 到 10.255.255.255。A类，或记为10.0.0.0/8，它又称为24位块
2. 172.16.0.0 到 172.31.255.255。B类，或记为172.16.0.0/12，它又称为20位块
3. 192.168.0.0 到 192.168.255.255。C类，或记为192.168.0.0/16，它又称为16位块

采用这样的专用 IP 地址的互连网络称为专用互联网或本地互联网，或更简单些，就叫作专用网，专用IP地址也叫作可重用地址(reusable address)，因为这些专用地址仅在本机构内部使用。

### 虚拟专用网 VPN

利用公用的互联网作为本机构各专用网之间的通信载体，这样的专用网又称为虚拟专用网VPN (Virtual Private Network)。
“专用网”是因为这种网络是为本机构的主机用于机构内部的通信，而不是用于和网络外非本机构的主机通信。“虚拟”表示“好像是”，但实际上并不是，因为现在并没有真正使用通信专线，而VPN只是在效果上和真正的专用网一样

如果专用网不同网点之间的通信必须经过公用的互联网，但又有保密的要求，那么所有通过互联网传送的数据都必须加密。一个机构要构建自己的 VPN 就必须为它的每一个场所购买专门的硬件和软件，并进行配置，使每一个场所的 VPN 系统都知道其他场所的地址。由部门 A 和 B 的内部网络所构成的虚拟专用网 VPN 又称为内联网 (intranet)，表示部门 A 和 B 都是在同一个机构的内部。一个机构和某些外部机构共同建立的虚拟专用网 VPN 又称为外联网 (extranet)

![捕获15](https://zcayo.oss-cn-beijing.aliyuncs.com/%E5%9B%BE%E7%89%87/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E6%8D%95%E8%8E%B715.PNG)

远程接入 VPN (remote access VPN)可以满足外部流动员工访问公司网络的需求。在外地工作的员工拨号接入互联网，而驻留在员工 PC 机中的 VPN 软件可在员工的 PC 机和公司的主机之间建立 VPN 隧道，因而外地员工与公司通信的内容是保密的，员工们感到好像就是使用公司内部的本地网络

### 网络地址转换 NAT

网络地址转换 NAT (Network Address Translation) ，需要在专用网连接到互联网的路由器上安装 NAT 软件，装有 NAT 软件的路由器叫作 NAT路由器，它至少有一个有效的外部全球IP地址。所有使用本地地址的主机在和外界通信时，都要在 NAT 路由器上将其本地地址转换成全球 IP 地址，才能和互联网连接

#### 网络地址转换的过程

1. 内部主机 A 用本地地址 IPA 和互联网上主机 B 通信所发送的数据报必须经过 NAT 路由器。
2. NAT 路由器将数据报的源地址 IPA 转换成全球地址 IPG，并把转换结果记录到NAT地址转换表中，目的地址 IPB 保持不变，然后发送到互联网。
3. NAT 路由器收到主机 B 发回的数据报时，知道数据报中的源地址是 IPB 而目的地址是 IPG。
4. 根据 NAT 转换表，NAT 路由器将目的地址 IPG 转换为 IPA，转发给最终的内部主机 A

![捕获17](https://zcayo.oss-cn-beijing.aliyuncs.com/%E5%9B%BE%E7%89%87/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E6%8D%95%E8%8E%B717.PNG)

### 网络地址与端口号转换 NAPT 

为了更加有效地利用 NAT 路由器上的全球IP地址，现在常用的 NAT 转换表把运输层的端口号也利用上。这样，就可以使多个拥有本地地址的主机，共用一个 NAT 路由器上的全球 IP 地址，因而可以同时和互联网上的不同主机进行通信。使用端口号的 NAT 叫作网络地址与端口号转换NAPT (Network Address and Port Translation)，而不使用端口号的 NAT 就叫作传统的 NAT (traditional NAT)

![捕获16](https://zcayo.oss-cn-beijing.aliyuncs.com/%E5%9B%BE%E7%89%87/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E6%8D%95%E8%8E%B716.PNG)

NAPT把专用网内不同的源 IP 地址，都转换为同样的全球 IP 地址。但对源主机所采用的 TCP 端口号（不管相同或不同），则转换为不同的新的端口号。因此，当 NAPT 路由器收到从互联网发来的应答时，就可以从 IP 数据报的数据部分找出运输层的端口号，然后根据不同的目的端口号，从 NAPT 转换表中找到正确的目的主机